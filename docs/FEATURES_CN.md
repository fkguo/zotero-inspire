# Zotero INSPIRE 功能总结

本文档介绍 Zotero INSPIRE 插件的所有功能。

## 目录

- [右键菜单元数据更新](#右键菜单元数据更新)
- [INSPIRE 引用面板](#inspire-引用面板)
- [面板交互功能](#面板交互功能)
- [PDF 阅读器集成](#pdf-阅读器集成)
- [导航功能](#导航功能)
- [导入功能](#导入功能)
- [元数据处理](#元数据处理)
- [偏好设置](#偏好设置)

---

## 右键菜单功能

在 Zotero 中右键点击条目或合集，选择 **INSPIRE** 子菜单可访问以下功能：

### 条目右键菜单

| 功能组 | 选项 | 描述 |
|--------|------|------|
| **更新元数据** | `With abstracts` | 获取全部元数据，包括摘要 |
| | `Without abstracts` | 获取元数据但不更新摘要字段 |
| | `Citation counts only` | 只更新 INSPIRE 引用数（含/不含自引）和 CrossRef 引用数 |
| **缓存** | `Download references cache` *(1.1.3+)* | 预先将所选条目的 INSPIRE References 写入本地缓存，并显示进度及成功/失败统计 |
| **复制** *(1.1.4+)* | `Copy BibTeX` | 从 INSPIRE 获取并复制 BibTeX |
| | `Copy INSPIRE link` | 复制 INSPIRE 文献链接 |
| | `Copy citation key` | 复制条目的 citation key |
| | `Copy Zotero link` | 复制 Zotero 选择链接 |
| **操作** | `Cancel update` | 取消正在进行的更新操作 |

### 合集右键菜单

合集右键菜单包含更新和缓存功能（不含复制功能，因为复制操作针对单个条目）：
- 更新元数据（三种模式）
- 下载 References Cache（批量处理合集中所有条目）
- 取消更新

### 批量下载缓存

右键点击整个合集（Collection）选择 **INSPIRE** → **Download references cache**，插件会自动提取该合集中所有包含 INSPIRE ID 的条目并批量下载缓存。

---

## INSPIRE 引用面板

在条目详情面板中，INSPIRE 插件添加了一个专用面板，包含以下标签页：

| 标签页                  | 功能描述                                     |
| ----------------------- | -------------------------------------------- |
| **References**    | 显示当前文献的参考文献列表                   |
| **Cited by**      | 显示引用当前文献的所有论文                   |
| **Entry Cited**   | 查看某条参考文献的被引记录（点击引用数触发） |
| **Author Papers** | 查看某位作者的所有论文（点击作者名触发）     |
| **🔍 Search**     | INSPIRE 搜索结果（从搜索栏触发时显示）       |

### INSPIRE 搜索

从 Zotero 主搜索栏直接搜索 INSPIRE：

1. 在搜索栏输入 `inspire:` 前缀，后跟搜索词
2. 按 Enter 键执行搜索
3. 搜索结果显示在 INSPIRE 面板的 "Search" 标签页中
4. 也可在 "Search" 标签页中直接用 INSPIRE 语法搜索

**搜索语法示例**：

| 语法                          | 说明                                |
| ----------------------------- | ----------------------------------- |
| `inspire: a Witten`         | 搜索作者名为 Witten 的论文          |
| `inspire: t quark mass`     | 搜索标题包含 "quark mass" 的论文    |
| `inspire: arXiv:2305.12345` | 搜索特定 arXiv 编号                 |
| `inspire: j Phys.Rev.D`     | 搜索发表在 Physical Review D 的论文 |

**搜索历史**：

- 最近 10 条搜索会被记住
- 在面板搜索输入框旁的下拉菜单中可快速选择历史搜索
- 可清除搜索历史

---

## 面板交互功能

### 统计图表

在 References、Cited by 和 Author Papers 标签页中，面板顶部显示统计图表:

- **两种视图模式**：**按年份**和**按引用数**
- **汇总统计**：
  - 按年份模式：右上角显示总文章数（如 "45 papers"）
  - 按引用数模式：右上角显示总引用数、h-index、篇均引用（如 "1,234 cit. · h=15 · avg 27.4"）
- **交互筛选**：
  - 点击柱状图可筛选对应区间的条目
  - 按住 Ctrl/Cmd 键可多选多个区间
  - 再次点击已选中的柱状图可取消选择
  - 筛选结果与文本过滤器结合（AND 逻辑）
- **折叠/展开**：点击折叠按钮可收起图表以节省空间
- **折叠自动清空筛选**：折叠瞬间会清空所有图表筛选，避免隐藏过滤器影响列表加载
- **默认折叠**：可在偏好设置中配置图表是否默认折叠
- **作者数过滤**：点击 "≤10 Authors" 按钮可过滤仅显示作者数 ≤10 的论文（排除大型合作组）
- **Published 过滤**：点击 "Published only" 按钮可过滤仅显示有 journal information 的论文（正式发表的论文），过滤掉只有 arXiv 没有 journal information 的论文。若论文既有 journal 信息又有 arXiv，仍会显示（因为这是正式发表的论文）
- **清除筛选**：任意过滤器激活时显示清除按钮（文本、直方图、≤10人、Quick Filters 等），一键清除全部筛选条件

### 搜索与过滤

- **过滤器**：支持多词搜索
- **短语搜索**：使用双引号 `"..."` 包裹文本可进行精确短语匹配，忽略空格和标点符号
  - 例如：`"Phys Rev Lett"` 可匹配 "Physical Review Letters" 或 "Phys. Rev. Lett."
- **期刊缩写支持**：支持使用期刊缩写快速过滤
  - 例如：输入 `"PRL"` 可匹配 "Physical Review Letters"
  - 支持常见物理期刊缩写：PRL、PRC、PRD、JHEP、NPA、NPB、PLB、EPJA、EPJC、CPC、CPL 等
- **特殊字符处理**：自动处理德语变音符（ä→ae）、北欧字符等
- **排序选项**：
  - INSPIRE 原始顺序
  - 最新优先
  - 最多引用优先
- **快速筛选 (Filters 按钮)**：
  - 工具栏 `Filters` 按钮提供 🔥 高引用、📅 最近 5 年、📅 最近 1 年、📰 已发表、📝 仅预印本、⭐ 仅已关联 等预设，勾选即可叠加条件
  - 所有快速筛选与文本过滤、图表筛选、作者数过滤采用 AND 逻辑，并会立即同步统计图表柱状数据
  - 插件会记住上次的快速筛选组合，重新打开面板时自动恢复

### 状态指示

| 图标      | 含义                          |
| --------- | ----------------------------- |
| ● (绿色) | 本地库中已有此条目            |
| ⊕ (红色) | 可点击添加到库                |
| 🔗 (橙色) | 已关联为相关条目              |
| 🔗 (灰色) | 未关联                        |
| 📋        | 复制 BibTeX（点击获取并复制） |

### 交互操作

| 操作                 | 效果                           |
| -------------------- | ------------------------------ |
| 点击圆点（本地已有） | 跳转到本地条目                 |
| 双击圆点（本地已有） | 直接打开 PDF（如有）           |
| 点击圆点（未添加）   | 打开导入对话框                 |
| 点击链接图标         | 关联/取消关联为相关条目        |
| 点击剪贴板图标       | 复制 BibTeX 到剪贴板           |
| 点击引用数           | 打开该条目的被引记录标签页     |
| 点击标题             | 在浏览器中打开 INSPIRE 页面    |
| 悬停标题             | 显示摘要 tooltip（带加载状态） |
| 点击作者名           | 查看该作者的所有论文           |

### 工具栏按钮

| 按钮            | 功能                                            |
| --------------- | ----------------------------------------------- |
| 刷新按钮        | 清除缓存，从 INSPIRE 重新获取当前视图的最新数据 |
| 批量复制 BibTeX | 一键复制所有可见条目的 BibTeX 到剪贴板（支持选中条目） |

### 批量导入功能 (v1.1.4)

References Panel 支持批量选择和导入多条参考文献：

- **复选框选择**：条目左侧显示复选框，支持：
  - 单击：单选条目
  - Shift+Click：范围选择（从上次选中到当前）
  - Ctrl/Cmd+Click：多选条目
- **批量工具栏**：选中条目后，面板顶部显示批量工具栏：
  - 选中数量徽章：显示 "N selected"
  - "Select All"：选中当前过滤后的所有条目
  - "Clear"：清除所有选择
  - "Import"：执行批量导入
- **重复检测**：导入前自动检测本地库中的重复条目（基于 recid/arXiv/DOI），显示重复提示弹窗：
  - 列出所有重复条目及其匹配类型
  - 支持"全跳过"/"全导入"快捷操作
  - 可逐项选择是否导入重复项
- **批量导入**：
  - 一次性选择保存目标（库/文件夹/标签/笔记）
  - 显示导入进度和统计（成功/失败数量）
  - 支持 ESC 键取消导入
  - 成功导入后自动更新条目状态（显示绿色圆点）
- **导出功能增强**：右上角复制/导出按钮支持选中条目：
  - 有选中条目时：仅导出选中的条目，菜单标题显示数量
  - 无选中条目时：导出所有可见条目（保持原有行为）

### 本地缓存与离线使用 (v1.1.3)

插件引入了强大的本地缓存系统，支持离线浏览并优化性能。

**功能特性**：

- **持久化存储**：References、Cited By 和 Author Papers 数据会保存到本地磁盘（JSON 格式）。
- **TTL 控制**：References 永久有效；Cited By / Author Papers 默认 24 小时过期（可在偏好设置调整）。
- **智能缓存策略**：
  - **References**：始终只存储一份无排序的缓存，排序在客户端完成。
  - **Cited By**：当引用数 ≤ 10,000 时，只存储一份缓存；超过时按不同排序分别存储（因 API 数据集不同）。
  - **完整性校验**：自动检测缓存文件完整性，损坏或旧版本会自动重新获取。
- **gzip 压缩**：支持在偏好设置中勾选“Compress cache files (gzip)”（默认启用），大文件会自动压缩为 `.json.gz`，磁盘占用可降低约 80%，同时统计面板会显示压缩/未压缩文件数与容量。
- **随机抽样校验**：读取缓存时会抽检多个条目（标题 + recid/texkey），防止损坏或截断数据影响面板展示。
- **批量下载**：右键条目或合集可预先下载缓存，非常适合出差或无网环境使用。
- **后台更新**：引用计数（Citation Count）等变动数据会在加载缓存后在后台静默刷新。
- **管理**：在偏好设置中可自定义缓存目录、一键清理缓存、查看缓存统计。

---

## PDF 阅读器集成

*新功能 (v2.0.0)*

在 Zotero PDF 阅读器中选中包含引用标记的文本时，插件会自动识别并提供查找按钮：

### 引用识别

- **选中文本**：在 PDF 中选中包含引用的文本（如 "see Refs. [1,2,3]"）
- **弹出按钮**：检测到引用后，选择弹出菜单中显示 "INSPIRE Refs. [n]" 按钮
- **多引用支持**：选中多个引用时，显示多个按钮供选择

### 支持的引用格式

| 格式 | 示例 |
|------|------|
| 单个数字 | `[1]`, `[42]` |
| 多个数字 | `[1,2,3]`, `[1, 2, 3]` |
| 数字范围 | `[1-5]`, `[1–5]` |
| 混合格式 | `[1,3-5,7]` |
| 作者-年份 | `[Smith 2024]`, `[WGR17]` |
| arXiv ID | `[arXiv:2301.12345]`, `[hep-ph/9901234]` |
| 上标数字 | ¹²³⁴⁵⁶⁷⁸⁹⁰ |

### 面板联动

点击查找按钮后：
1. 自动切换到 References 标签页
2. 高亮显示对应的引用条目（临时高亮 + 持久焦点选中）
3. 滚动到该条目位置

### 持久焦点选中

从 PDF 查找跳转后，条目会保持焦点选中状态（淡蓝背景 + 蓝色左边框），方便确认对应文献：

- **持久显示**：焦点选中不会自动消失，直到用户主动清除
- **清除方式**：按 Escape 键、切换标签页、刷新数据、或点击其他条目
- **与复选框独立**：焦点选中不影响批量导入的复选框选择

### 模糊检测模式（实验性）

当 PDF 文本层存在问题（如方括号被截断）时，可在偏好设置中启用"模糊引用检测"：

- **位置**：偏好设置 → References Panel → Fuzzy citation detection
- **功能**：识别缺少方括号的引用模式（如 "Bali 19" → `[19]`）
- **智能排除**：自动排除文档结构词（Section, Figure, Table 等）、物理单位（GeV, MeV 等）、小数、时间等非引用数字
- **默认关闭**：由于可能产生误判，默认不启用

---

## 导航功能

### 浏览历史

- **Back 按钮**：返回上一个查看的条目
- **Forward 按钮**：前进到下一个条目
- 支持跨阅读器标签页导航
- 可配置自动重新打开已关闭的阅读器标签页

### 使用场景

1. 在 References 面板中点击某条参考文献跳转
2. 使用 Back 按钮返回原来的条目
3. 如果原条目在 PDF 阅读器中打开，可自动切换回阅读器标签

---

## 导入功能

从 INSPIRE 导入条目时，支持以下选项：

### 目标选择

- 选择目标库（个人库/群组库）
- 选择一个或多个目标文件夹
- 可拖拽、可调整大小的选择对话框

### 附加选项

- **标签**：添加标签（支持自动完成，从现有标签中选择）
- **笔记**：为导入的条目添加笔记

---

## 元数据处理

### 更新的字段

| 字段            | 说明                                                                              |
| --------------- | --------------------------------------------------------------------------------- |
| 期刊缩写        | INSPIRE 标准期刊缩写                                                              |
| 卷、期、页码    | 完整的出版信息                                                                    |
| DOI             | 数字对象标识符                                                                    |
| arXiv 信息      | arXiv ID 及主分类                                                                 |
| 引用计数        | 含/不含自引的引用数                                                               |
| 摘要            | 论文摘要（可选）                                                                  |
| 作者列表        | 超过10位作者时保留前3位 + "others"；面板显示时超过20位作者只显示第一位 + "et al." |
| Citation Key    | INSPIRE 的 texkey（可配置）                                                       |
| Archive         | 设为 "INSPIRE"                                                                    |
| Loc. in Archive | INSPIRE recid                                                                     |

### 特殊处理

- **勘误信息**：作为笔记添加
- **数学公式**：清理标题中的 LaTeX 公式

### 数据来源识别

插件可从以下信息获取 INSPIRE 记录：

1. DOI 字段
2. Extra 字段中的 arXiv ID
3. URL 字段中的 arXiv 链接或 INSPIRE 链接
4. Extra 字段中的 DOI
5. Loc. in Archive 字段中的 recid
6. Extra 字段中的 Citation Key

---

## 偏好设置

通过 `工具` → `插件` → `INSPIRE Metadata Updater` → `首选项` 访问：

### 新条目自动获取

| 选项     | 说明                                   |
| -------- | -------------------------------------- |
| 含摘要   | 添加新条目时自动获取完整元数据         |
| 不含摘要 | 添加新条目时自动获取元数据（不含摘要） |
| 仅引用数 | 添加新条目时只获取引用数               |
| 禁用     | 不自动获取                             |

### Citation Key 设置

- **INSPIRE citekey**：使用 INSPIRE 的 texkey 作为 Citation Key
- **禁用**：不设置 Citation Key

### Extra 字段顺序

- **引用优先**：引用数显示在 Extra 字段顶部
- **arXiv 优先**：arXiv ID 显示在 Extra 字段顶部

### arXiv 分类标签

- 启用后，自动将 arXiv 主分类（如 hep-ph、nucl-th）添加为标签

### 引用面板设置

- **最大显示作者数**：设置在面板中显示多少位作者后显示 "et al."

### 本地缓存设置 (v1.1.3+)

控制用于离线浏览的持久化缓存：

- **启用本地缓存**：总开关，禁用后仅使用内存缓存
- **显示缓存来源指示器**：在面板状态栏显示当前视图数据来源（INSPIRE / Memory / Local）
- **缓存 TTL (小时)**：适用于 Cited by 和 Author Papers 标签页的缓存有效期（References 永久有效）
- **元数据补全过程**：可调节单批补全数量（25–110 条）与并行请求数（1–5 个），用于获取缺失的作者/标题/引用数。提高数值能加快补全，但超过 INSPIRE 限制会触发 HTTP 400/502。
- **自定义缓存目录**：留空使用 Zotero 数据目录，或点击 "Browse..." 选择自定义文件夹
- **清除缓存**：一键删除所有磁盘缓存文件并显示释放的空间和文件数

### 阅读器导航设置

- **自动重新打开阅读器**：使用 Back/Forward 导航时，自动重新打开已关闭的阅读器标签页

### INSPIRE 记录未找到

- **添加标签**：为未找到 INSPIRE 记录的条目添加标签（默认：`⛔ No INSPIRE recid found`）

---

## 与其他工具的集成

### Better BibTeX

- 自动设置 INSPIRE Citation Key
- 在 Extra 字段中保存 Citation Key 以便 BBT 识别

### Look-up Engines

可在 Zotero 的 `engines.json` 中添加 INSPIRE 查找引擎：

```json
{
  "_name": "INSPIRE",
  "_urlTemplate": "https://inspirehep.net/literature/{z:archiveLocation}"
}
```

### Actions & Tags 插件

可设置动作一键复制 INSPIRE 链接。

---

## 性能优化

本插件进行了多项性能优化以提升用户体验：

### 渲染优化

- **Filter 防抖**: 快速输入时自动延迟重渲染，避免界面卡顿
- **图表延迟计算**: 图表在后台渲染，不阻塞列表显示
- **Row 元素池化**: 复用 DOM 元素，减少内存分配
- **无限滚动**: 滚动到列表底部时自动加载更多条目

### 数据获取优化

- **Citation Count 并行获取**: 多批次同时请求，减少等待时间
- **本地状态批量查询**: 优化数据库查询，减少交互次数
- **缓存写入优化 (v1.1.3)**: 采用智能策略减少磁盘写入次数（References 仅需写入一次而非三次）

### 内存管理

- **LRU 缓存**: 限制缓存大小，防止长期使用导致内存增长
- **搜索文本缓存**: 避免重复计算搜索字符串
- **缓存统计监控** *(v2.1.0)*: LRUCache 支持命中/未命中统计，可用于性能分析

### 调试命令 (v2.1.0)

插件在 Zotero 控制台中提供调试命令，可在 `工具` → `开发者` → `Error Console` 中使用：

| 命令 | 说明 |
|------|------|
| `Zotero.ZoteroInspire.getCacheStats()` | 获取所有缓存的统计信息（命中率、大小等） |
| `Zotero.ZoteroInspire.logCacheStats()` | 输出缓存统计到调试日志 |
| `Zotero.ZoteroInspire.resetCacheStats()` | 重置所有缓存的统计计数器 |
| `Zotero.ZoteroInspire.startMemoryMonitor(ms)` | 启动周期性内存监控（默认 30 秒间隔） |
| `Zotero.ZoteroInspire.stopMemoryMonitor()` | 停止内存监控 |

**缓存统计示例输出**:
```
processedData: 85.2% hit rate (23/27), size: 15/20
pageData: 92.1% hit rate (117/127), size: 48/50
pdfMapping: 78.6% hit rate (11/14), size: 8/30
recidLookup: 95.0% hit rate (190/200), size: 156/500
[Overall]: 91.3% hit rate (341/368)
```

---

## 架构重构 (v2.1.0)

v2.1.0 版本对内部架构进行了重大重构，提升代码质量、模块化程度和可维护性：

### 模块化面板架构

从主控制器中提取了 6 个独立的管理器类：

| 管理器 | 职责 |
|--------|------|
| `ChartManager` | 统计图表渲染和交互 |
| `FilterManager` | 文本过滤、Quick Filters、作者/已发表过滤 |
| `NavigationManager` | 前进/后退导航历史，滚动状态保存 |
| `ExportManager` | BibTeX/LaTeX 导出到剪贴板或文件 |
| `BatchImportManager` | 批量选择、重复检测、批量导入 |
| `RowPoolManager` | 行元素池化和模板管理（PERF-13 优化核心） |

### 性能监控

新增 `PerformanceMonitor` 类用于性能计时和慢操作检测：
- 支持同步和异步操作计时
- 统计 API（平均值、最大值、调用次数）
- 可配置的慢操作阈值和回调

新增 `MemoryMonitor` 类用于缓存统计和内存监控：
- 集中管理所有 LRUCache 实例的统计
- 支持周期性日志输出
- 提供控制台调试命令

### 单元测试覆盖

使用 Vitest 框架添加了 153 个单元测试，覆盖：
- 文本规范化和过滤
- 过滤谓词和 Quick Filters
- API 类型守卫和工具函数
- PDF 引用匹配策略

### 代码质量改进

- 魔法数字替换为命名常量
- 内联样式整合到样式工具模块
- 过滤方法使用策略模式统一
- 完整的 INSPIRE API 类型定义和类型守卫

---

## 技术说明

### API 使用

本插件使用 [INSPIRE REST API](https://github.com/inspirehep/rest-api-doc) 获取数据。

### 速率限制

INSPIRE API 限制每 5 秒最多 15 个请求。插件已优化请求频率以避免超限。

### 缓存

- 引用列表和被引记录会在会话中缓存（LRU 限制）
- 元数据会缓存以减少重复请求（最多 500 条）
- **本地磁盘缓存** (v1.1.3)：支持持久化存储，支持离线访问
- 点击 Refresh 按钮可强制刷新（同时更新内存和本地缓存）

---

*本文档对应插件版本：2.1.0（最后更新：2025-12-12）*
